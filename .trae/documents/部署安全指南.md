# 部署安全指南

## 概述

本指南提供了「小星星成长记」项目在部署过程中的安全最佳实践，包括敏感信息管理、Git 历史清理、环境变量配置等关键安全措施。

## Git 历史安全管理

### 敏感文件清理

#### 问题描述

在开发过程中，可能会意外将包含敏感信息的文件（如 `.env`）提交到 Git 仓库。即使后续删除这些文件，敏感信息仍然存在于 Git 历史中，可能导致安全风险。

#### 清理步骤

##### 方法一：使用 BFG Repo-Cleaner（推荐）

1. **安装 BFG Repo-Cleaner**:
   ```bash
   # macOS
   brew install bfg
   
   # 其他系统请访问: https://rtyley.github.io/bfg-repo-cleaner/
   ```

2. **清理敏感文件**:
   ```bash
   # 删除所有历史中的 .env 文件
   bfg --delete-files .env
   
   # 删除包含敏感信息的文件夹
   bfg --delete-folders secrets
   
   # 替换敏感文本内容
   bfg --replace-text passwords.txt
   ```

3. **清理 Git 仓库**:
   ```bash
   git reflog expire --expire=now --all
   git gc --prune=now --aggressive
   ```

4. **强制推送到远程仓库**:
   ```bash
   git push --force-with-lease origin main
   ```

##### 方法二：使用 git filter-branch

```bash
# 从所有分支和标签中移除 .env 文件
git filter-branch --force --index-filter \
  'git rm --cached --ignore-unmatch .env' \
  --prune-empty --tag-name-filter cat -- --all

# 清理备份文件
rm -rf .git/refs/original/

# 垃圾回收
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# 强制推送
git push --force-with-lease origin main
```

#### 验证清理结果

```bash
# 检查文件是否已从历史中移除
git log --all --full-history -- .env

# 搜索可能的敏感信息
git log --all --grep="password\|secret\|key" --oneline

# 检查所有提交中的文件变更
git log --all --name-only | grep -E "\.(env|key|pem|p12)$"
```

### 预防措施

#### 1. 完善 .gitignore

确保 `.gitignore` 文件包含所有敏感文件类型：

```gitignore
# 环境变量文件
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# 密钥文件
*.key
*.pem
*.p12
*.pfx

# 配置文件
config/secrets.json
config/database.json

# 日志文件
*.log
logs/

# 临时文件
.DS_Store
Thumbs.db

# IDE 配置
.vscode/settings.json
.idea/

# 依赖目录
node_modules/
.pnp
.pnp.js

# 构建输出
dist/
build/
.next/

# 测试覆盖率
coverage/
.nyc_output

# 缓存目录
.cache/
.parcel-cache/

# 运行时数据
pids
*.pid
*.seed
*.pid.lock

# 可选的 npm 缓存目录
.npm

# 可选的 eslint 缓存
.eslintcache

# 可选的 REPL 历史
.node_repl_history

# 输出的 npm 调试日志
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# 运行时数据
pids
*.pid
*.seed
*.pid.lock

# 目录用于仪表化库生成的覆盖率报告
lib-cov

# nyc 测试覆盖率
.nyc_output

# Grunt 中间存储
.grunt

# Bower 依赖目录
bower_components

# node-waf 配置
.lock-wscript

# 编译的二进制插件
build/Release

# 依赖目录
node_modules/
jspm_packages/

# TypeScript v1 声明文件
typings/

# 可选的 npm 缓存目录
.npm

# 可选的 eslint 缓存
.eslintcache

# 可选的 REPL 历史
.node_repl_history

# 输出的 npm 调试日志
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# 运行时数据
pids
*.pid
*.seed
*.pid.lock

# 目录用于仪表化库生成的覆盖率报告
lib-cov

# nyc 测试覆盖率
.nyc_output

# Grunt 中间存储
.grunt

# Bower 依赖目录
bower_components

# node-waf 配置
.lock-wscript

# 编译的二进制插件
build/Release

# 依赖目录
node_modules/
jspm_packages/

# TypeScript v1 声明文件
typings/
```

#### 2. 使用 Git Hooks

创建 pre-commit hook 检查敏感文件：

```bash
#!/bin/sh
# .git/hooks/pre-commit

# 检查是否包含敏感文件
if git diff --cached --name-only | grep -E "\.(env|key|pem|p12)$"; then
    echo "错误: 检测到敏感文件，请移除后再提交"
    exit 1
fi

# 检查是否包含敏感内容
if git diff --cached | grep -E "(password|secret|api_key|private_key)\s*=\s*['\"][^'\"]+['\"]" --ignore-case; then
    echo "错误: 检测到可能的敏感信息，请检查后再提交"
    exit 1
fi

exit 0
```

#### 3. 使用 git-secrets

安装和配置 git-secrets 工具：

```bash
# 安装 git-secrets
brew install git-secrets

# 在仓库中安装 hooks
git secrets --install

# 注册 AWS 密钥模式
git secrets --register-aws

# 添加自定义模式
git secrets --add 'password\s*=\s*['\"][^'\"]+['\"]'
git secrets --add 'api_key\s*=\s*['\"][^'\"]+['\"]'
git secrets --add 'secret\s*=\s*['\"][^'\"]+['\"]'

# 扫描现有历史
git secrets --scan-history
```

## 环境变量安全管理

### 分类管理

#### 公开变量（前端可访问）

使用 `VITE_` 前缀，这些变量会被打包到前端代码中：

```bash
# 可以暴露给前端的变量
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
VITE_APP_NAME=小星星成长记
VITE_APP_VERSION=1.0.0
```

#### 私密变量（仅后端使用）

不使用 `VITE_` 前缀，仅在服务器端可访问：

```bash
# 仅服务器端使用的敏感变量
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
DATABASE_URL=postgresql://user:password@host:port/database
JWT_SECRET=your-jwt-secret
EMAIL_API_KEY=your-email-service-api-key
```

### 环境变量模板

创建 `.env.example` 文件作为模板：

```bash
# =============================================================================
# 环境变量配置模板
# =============================================================================
# 
# 使用说明：
# 1. 复制此文件为 .env
# 2. 填入实际的配置值
# 3. 确保 .env 文件已添加到 .gitignore
# 
# 安全提醒：
# - 前端变量使用 VITE_ 前缀
# - 敏感信息仅在服务器端使用
# - 定期轮换 API 密钥
# =============================================================================

# Supabase 配置
# 获取地址: https://supabase.com/dashboard/project/your-project/settings/api
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key-here

# 应用配置
VITE_APP_NAME=小星星成长记
VITE_APP_VERSION=1.0.0
VITE_APP_ENVIRONMENT=development

# 可选：第三方服务配置
# VITE_ANALYTICS_ID=your-analytics-id
# VITE_SENTRY_DSN=your-sentry-dsn

# =============================================================================
# 以下变量仅在服务器端使用，不要添加 VITE_ 前缀
# =============================================================================

# Supabase 服务端密钥（仅在后端 API 中使用）
# SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# 数据库连接（如果直接连接数据库）
# DATABASE_URL=postgresql://user:password@host:port/database

# JWT 密钥（如果使用自定义 JWT）
# JWT_SECRET=your-jwt-secret-here

# 邮件服务配置
# EMAIL_API_KEY=your-email-service-api-key
# EMAIL_FROM=noreply@yourdomain.com

# 文件存储配置
# STORAGE_BUCKET=your-storage-bucket
# STORAGE_REGION=your-storage-region
```

### 部署平台配置

#### Vercel 环境变量

1. **通过 Dashboard 配置**:
   - 登录 Vercel Dashboard
   - 选择项目 → Settings → Environment Variables
   - 添加所需变量

2. **通过 CLI 配置**:
   ```bash
   # 添加环境变量
   vercel env add VITE_SUPABASE_URL production
   vercel env add VITE_SUPABASE_ANON_KEY production
   
   # 从本地 .env 文件导入
   vercel env pull .env.local
   ```

3. **通过 vercel.json 配置**:
   ```json
   {
     "env": {
       "VITE_APP_NAME": "小星星成长记",
       "VITE_APP_VERSION": "1.0.0"
     },
     "build": {
       "env": {
         "VITE_SUPABASE_URL": "@supabase-url",
         "VITE_SUPABASE_ANON_KEY": "@supabase-anon-key"
       }
     }
   }
   ```

#### Netlify 环境变量

1. **通过 Dashboard 配置**:
   - Site settings → Environment variables
   - 添加变量和值

2. **通过 netlify.toml 配置**:
   ```toml
   [build.environment]
     VITE_APP_NAME = "小星星成长记"
     VITE_APP_VERSION = "1.0.0"
   ```

## 代码安全审查

### 自动化检查

#### 1. 使用 ESLint 规则

```javascript
// .eslintrc.js
module.exports = {
  rules: {
    'no-console': 'warn',
    'no-debugger': 'error',
    'no-alert': 'error',
    // 禁止硬编码敏感信息
    'no-secrets/no-secrets': 'error'
  },
  plugins: ['no-secrets']
};
```

#### 2. 使用 Husky + lint-staged

```json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "pre-push": "npm run security-check"
    }
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "git add"
    ],
    "*.{json,md}": [
      "prettier --write",
      "git add"
    ]
  }
}
```

#### 3. 安全扫描脚本

```bash
#!/bin/bash
# scripts/security-check.sh

echo "🔍 执行安全检查..."

# 检查依赖漏洞
npm audit --audit-level moderate

# 检查敏感文件
if find . -name "*.env*" -not -path "./node_modules/*" -not -name ".env.example" | grep -q .; then
    echo "❌ 发现敏感文件，请检查 .gitignore"
    exit 1
fi

# 检查硬编码密钥
if grep -r -E "(password|secret|api_key|private_key)\s*=\s*['\"][^'\"]+['\"]" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"; then
    echo "❌ 发现可能的硬编码敏感信息"
    exit 1
fi

echo "✅ 安全检查通过"
```

### 手动审查清单

#### 代码审查要点

- [ ] 没有硬编码的密码、API 密钥或其他敏感信息
- [ ] 所有环境变量都通过 `process.env` 或 `import.meta.env` 访问
- [ ] 前端代码中没有使用 Service Role Key
- [ ] 数据库查询使用参数化查询，防止 SQL 注入
- [ ] 用户输入都经过适当的验证和清理
- [ ] 错误信息不暴露敏感的系统信息
- [ ] 日志记录不包含敏感数据
- [ ] 文件上传功能有适当的类型和大小限制

#### 配置审查要点

- [ ] `.gitignore` 文件包含所有敏感文件类型
- [ ] 生产环境使用 HTTPS
- [ ] 设置了适当的 CORS 策略
- [ ] 配置了内容安全策略 (CSP)
- [ ] 启用了安全头部 (Security Headers)
- [ ] 数据库连接使用 SSL
- [ ] 定期备份重要数据

## 监控和响应

### 安全监控

#### 1. 日志监控

```javascript
// utils/logger.js
const logger = {
  info: (message, meta = {}) => {
    console.log(JSON.stringify({
      level: 'info',
      message,
      timestamp: new Date().toISOString(),
      ...meta
    }));
  },
  
  error: (message, error = {}, meta = {}) => {
    console.error(JSON.stringify({
      level: 'error',
      message,
      error: {
        name: error.name,
        message: error.message,
        stack: error.stack
      },
      timestamp: new Date().toISOString(),
      ...meta
    }));
  },
  
  security: (event, meta = {}) => {
    console.warn(JSON.stringify({
      level: 'security',
      event,
      timestamp: new Date().toISOString(),
      ...meta
    }));
  }
};

export default logger;
```

#### 2. 异常检测

```javascript
// utils/security.js
import logger from './logger.js';

export const detectSuspiciousActivity = (req) => {
  const suspiciousPatterns = [
    /\b(union|select|insert|delete|drop|create|alter)\b/i,
    /<script[^>]*>.*?<\/script>/gi,
    /javascript:/gi,
    /on\w+\s*=/gi
  ];
  
  const userInput = JSON.stringify(req.body);
  
  for (const pattern of suspiciousPatterns) {
    if (pattern.test(userInput)) {
      logger.security('Suspicious input detected', {
        pattern: pattern.toString(),
        input: userInput.substring(0, 100),
        ip: req.ip,
        userAgent: req.get('User-Agent')
      });
      return true;
    }
  }
  
  return false;
};
```

### 事件响应

#### 安全事件响应流程

1. **检测阶段**:
   - 监控系统发现异常
   - 自动告警触发
   - 人工发现可疑活动

2. **评估阶段**:
   - 确认事件性质和严重程度
   - 评估影响范围
   - 确定响应优先级

3. **响应阶段**:
   - 立即隔离受影响系统
   - 收集和保存证据
   - 通知相关人员
   - 实施临时缓解措施

4. **恢复阶段**:
   - 修复安全漏洞
   - 恢复正常服务
   - 验证系统安全性
   - 更新安全策略

5. **总结阶段**:
   - 分析事件原因
   - 更新安全流程
   - 培训相关人员
   - 改进监控系统

#### 紧急联系信息

```markdown
## 安全事件联系方式

### 内部联系人
- 技术负责人: [姓名] - [电话] - [邮箱]
- 安全负责人: [姓名] - [电话] - [邮箱]
- 项目经理: [姓名] - [电话] - [邮箱]

### 外部服务商
- Supabase 支持: support@supabase.io
- Vercel 支持: support@vercel.com
- 域名注册商: [联系方式]
- SSL 证书提供商: [联系方式]

### 应急措施
1. 立即更改所有 API 密钥
2. 暂停可疑用户账户
3. 启用维护模式
4. 联系服务提供商
5. 通知用户（如需要）
```

## 总结

通过实施本指南中的安全措施，可以显著提高「小星星成长记」项目的安全性：

### 已实施的安全措施

1. ✅ **Git 历史清理**: 使用 BFG 工具清理了历史中的敏感文件
2. ✅ **环境变量管理**: 创建了安全的环境变量配置模板
3. ✅ **代码审查**: 建立了自动化和手动的安全检查流程
4. ✅ **部署安全**: 提供了 Vercel 等平台的安全配置指南
5. ✅ **监控响应**: 建立了安全事件的监控和响应机制

### 持续改进建议

1. **定期安全审计**: 每季度进行一次全面的安全审查
2. **依赖更新**: 定期更新依赖包，修复已知漏洞
3. **安全培训**: 为团队成员提供安全意识培训
4. **渗透测试**: 定期进行渗透测试，发现潜在漏洞
5. **备份策略**: 建立完善的数据备份和恢复机制

### 紧急情况处理

如果发现安全问题，请立即：

1. 🚨 **停止服务**: 如果问题严重，立即启用维护模式
2. 🔒 **更换密钥**: 立即轮换所有 API 密钥和访问令牌
3. 📞 **通知团队**: 联系技术负责人和安全负责人
4. 📝 **记录事件**: 详细记录发现的问题和采取的措施
5. 🔍 **调查分析**: 分析问题原因，制定预防措施

---

**记住**: 安全是一个持续的过程，需要团队所有成员的共同努力和持续关注。