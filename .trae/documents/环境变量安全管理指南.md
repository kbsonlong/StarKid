# 环境变量安全管理指南

## 概述

本文档提供了「小星星成长记」项目中环境变量安全管理的最佳实践和指导原则。

## 🔒 安全原则

### 1. 前端 vs 后端环境变量

**前端环境变量（可公开）：**
- 以 `VITE_` 前缀开头的变量会被打包到前端代码中
- 这些变量在浏览器中是可见的，不应包含敏感信息
- 示例：`VITE_SUPABASE_URL`、`VITE_SUPABASE_ANON_KEY`

**后端环境变量（敏感）：**
- 不以 `VITE_` 开头的变量仅在服务器端可用
- 包含敏感信息，如 API 密钥、数据库连接字符串等
- 示例：`SUPABASE_SERVICE_ROLE_KEY`、`DATABASE_PASSWORD`

### 2. Supabase 密钥类型

**Anon Key（匿名密钥）：**
- ✅ 设计为公开使用
- ✅ 可以安全地包含在前端代码中
- ✅ 权限受 RLS（行级安全）策略限制
- ✅ 用于客户端认证和数据访问

**Service Role Key（服务角色密钥）：**
- ❌ 具有管理员权限
- ❌ 绝不应出现在前端代码中
- ❌ 可以绕过所有 RLS 策略
- ✅ 仅用于安全的后端环境

## 📁 文件结构

```
项目根目录/
├── .env                 # 实际环境变量（不提交到 Git）
├── .env.example         # 环境变量模板（提交到 Git）
├── .gitignore          # 确保 .env 文件被忽略
└── docs/               # 相关文档
```

## 🛠️ 配置步骤

### 1. 初始设置

1. 复制 `.env.example` 为 `.env`：
   ```bash
   cp .env.example .env
   ```

2. 从 Supabase 控制台获取配置：
   - 访问 [Supabase Dashboard](https://supabase.com/dashboard)
   - 选择项目 → Settings → API
   - 复制 Project URL 和 anon public key

3. 更新 `.env` 文件中的实际值

### 2. 验证配置

检查以下项目确保配置正确：

- [ ] `.env` 文件包含正确的 Supabase URL 和 Anon Key
- [ ] `.env` 文件不包含 Service Role Key
- [ ] `.gitignore` 包含 `.env` 文件
- [ ] 前端代码仅使用 `VITE_` 前缀的环境变量

## ⚠️ 安全检查清单

### 开发阶段
- [ ] 确保 `.env` 文件在 `.gitignore` 中
- [ ] 定期检查代码中是否意外包含敏感信息
- [ ] 使用 `.env.example` 作为团队配置模板
- [ ] 避免在代码注释中包含真实的密钥

### 部署阶段
- [ ] 在部署平台（如 Vercel）中单独配置环境变量
- [ ] 不要将 `.env` 文件上传到服务器
- [ ] 使用平台提供的安全环境变量管理功能
- [ ] 定期轮换敏感密钥

### 团队协作
- [ ] 新成员使用 `.env.example` 创建本地配置
- [ ] 通过安全渠道分享敏感配置信息
- [ ] 定期审查项目的环境变量使用情况
- [ ] 建立密钥泄露的应急响应流程

## 🚨 常见安全风险

### 1. Service Role Key 泄露
**风险：** 攻击者获得数据库完全访问权限
**预防：**
- 绝不在前端代码中使用 Service Role Key
- 定期轮换 Service Role Key
- 监控 Supabase 项目的异常访问

### 2. 环境变量意外提交
**风险：** 敏感信息暴露在版本控制中
**预防：**
- 确保 `.gitignore` 正确配置
- 使用 Git hooks 检查敏感信息
- 定期审查提交历史

### 3. 前端变量滥用
**风险：** 将敏感信息错误地暴露给客户端
**预防：**
- 仅在必要时使用 `VITE_` 前缀
- 定期审查前端环境变量的使用
- 通过 RLS 策略控制数据访问权限

## 🔧 故障排除

### 问题：应用无法连接到 Supabase
**解决方案：**
1. 检查 `.env` 文件是否存在
2. 验证 `VITE_SUPABASE_URL` 和 `VITE_SUPABASE_ANON_KEY` 是否正确
3. 确保没有多余的空格或换行符
4. 重启开发服务器

### 问题：权限被拒绝错误
**解决方案：**
1. 检查是否意外使用了 Service Role Key
2. 验证 RLS 策略是否正确配置
3. 确认用户认证状态
4. 检查数据库表的权限设置

### 问题：环境变量未生效
**解决方案：**
1. 确保变量名以 `VITE_` 开头（前端变量）
2. 重启开发服务器
3. 检查变量名拼写是否正确
4. 验证 `.env` 文件格式

## 📚 相关资源

- [Supabase 安全最佳实践](https://supabase.com/docs/guides/auth/row-level-security)
- [Vite 环境变量文档](https://vitejs.dev/guide/env-and-mode.html)
- [环境变量安全指南](https://12factor.net/config)

## 📞 支持

如果遇到安全相关问题，请：
1. 立即停止使用可能泄露的密钥
2. 在 Supabase 控制台中重新生成密钥
3. 更新所有相关的配置
4. 联系团队技术负责人

---

**最后更新：** 2024年1月
**版本：** 1.0
**维护者：** 小星星成长记开发团队