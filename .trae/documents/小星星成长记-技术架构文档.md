# å°æ˜Ÿæ˜Ÿæˆé•¿è®° - æŠ€æœ¯æ¶æ„æ–‡æ¡£

## 1. æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[ç”¨æˆ·æµè§ˆå™¨] --> B[Reactå‰ç«¯åº”ç”¨]
    B --> C[Supabase SDK]
    C --> D[SupabaseæœåŠ¡]
    
    subgraph "å‰ç«¯å±‚"
        B
    end
    
    subgraph "æœåŠ¡å±‚ (Supabaseæä¾›)"
        D --> D1[PostgreSQLæ•°æ®åº“]
        D --> D2[å®æ—¶è®¢é˜…]
        D --> D3[ç”¨æˆ·è®¤è¯]
        D --> D4[æ–‡ä»¶å­˜å‚¨]
    end
```

## 2. æŠ€æœ¯æè¿°

* å‰ç«¯ï¼šReact\@18 + TypeScript + TailwindCSS + Vite

* åç«¯ï¼šSupabase (PostgreSQL + å®æ—¶API + è®¤è¯)

* çŠ¶æ€ç®¡ç†ï¼šZustand

* UIç»„ä»¶ï¼šHeadless UI + è‡ªå®šä¹‰ç»„ä»¶

* å›¾è¡¨åº“ï¼šChart.js

* éƒ¨ç½²ï¼šVercel

## 3. è·¯ç”±å®šä¹‰

| è·¯ç”±         | ç”¨é€”               |
| ---------- | ---------------- |
| /          | é¦–é¡µï¼Œæ˜¾ç¤ºç§¯åˆ†æ¦‚è§ˆã€å¿«é€Ÿå¯¼èˆªå’Œå¥½å‹åŠ¨æ€   |
| /login     | ç™»å½•é¡µé¢ï¼Œæ”¯æŒæ‰‹æœºå·å’Œé‚®ç®±ç™»å½•  |
| /register  | æ³¨å†Œé¡µé¢ï¼Œåˆ›å»ºå®¶é•¿è´¦æˆ·      |
| /dashboard | ä»ªè¡¨æ¿ï¼Œå®¶åº­æ¦‚è§ˆå’Œæ•°æ®ç»Ÿè®¡    |
| /rules     | è§„åˆ™ç®¡ç†é¡µé¢ï¼Œç®¡ç†å¥–æƒ©è§„åˆ™å’Œå®¶é•¿åä½œ    |
| /records   | è¡Œä¸ºè®°å½•é¡µé¢ï¼Œè®°å½•å’ŒæŸ¥çœ‹è¡Œä¸ºå†å²ï¼Œæ”¯æŒåˆ†å·¥è®°å½• |
| /rewards   | ç§¯åˆ†å…‘æ¢é¡µé¢ï¼ŒæŸ¥çœ‹å’Œå…‘æ¢å¥–åŠ±   |
| /reports   | ç»Ÿè®¡æŠ¥å‘Šé¡µé¢ï¼ŒæŸ¥çœ‹æˆé•¿åˆ†æå’Œå®¶åº­å¯¹æ¯”    |
| /community | äº’åŠ¨ç¤¾åŒºé¡µé¢ï¼Œå„¿ç«¥å¥½å‹ç³»ç»Ÿå’Œæˆé•¿æŒ‘æˆ˜ |
| /collaborate | å®¶é•¿åä½œé¡µé¢ï¼Œæƒé™ç®¡ç†å’Œä»»åŠ¡åˆ†å·¥ |
| /settings  | è®¾ç½®é¡µé¢ï¼Œç”¨æˆ·å’Œç³»ç»Ÿè®¾ç½®ï¼Œå®‰å…¨ä¸­å¿ƒ     |
| /family    | å®¶åº­ç®¡ç†é¡µé¢ï¼Œç®¡ç†å®¶åº­æˆå‘˜å’Œé‚€è¯·ç     |

## 4. APIå®šä¹‰

### 4.1 æ ¸å¿ƒAPI

**ç”¨æˆ·è®¤è¯ç›¸å…³**

```
POST /auth/signup
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å      | å‚æ•°ç±»å‹   | æ˜¯å¦å¿…éœ€ | æè¿°   |
| -------- | ------ | ---- | ---- |
| email    | string | true | ç”¨æˆ·é‚®ç®± |
| password | string | true | ç”¨æˆ·å¯†ç  |
| name     | string | true | ç”¨æˆ·å§“å |

å“åº”å‚æ•°ï¼š

| å‚æ•°å     | å‚æ•°ç±»å‹   | æè¿°     |
| ------- | ------ | ------ |
| user    | object | ç”¨æˆ·ä¿¡æ¯å¯¹è±¡ |
| session | object | ä¼šè¯ä¿¡æ¯   |

**è§„åˆ™ç®¡ç†ç›¸å…³**

```
POST /api/rules
GET /api/rules
PUT /api/rules/:id
DELETE /api/rules/:id
POST /api/rules/vote
GET /api/rules/discussions
```

**è¡Œä¸ºè®°å½•ç›¸å…³**

```
POST /api/behaviors
GET /api/behaviors
GET /api/behaviors/stats
POST /api/behaviors/assign
GET /api/behaviors/assignments
```

**å®¶é•¿åä½œç›¸å…³**

```
POST /api/family/invite
POST /api/family/join
GET /api/family/members
PUT /api/family/permissions
POST /api/family/discussions
GET /api/family/tasks
```

**å„¿ç«¥äº’åŠ¨ç›¸å…³**

```
POST /api/children/invite
POST /api/children/friends
GET /api/children/friends
POST /api/challenges
GET /api/challenges
POST /api/challenges/join
GET /api/leaderboard
```

**å®‰å…¨èŠå¤©ç›¸å…³**

```
POST /api/chat/send
GET /api/chat/messages
POST /api/chat/report
GET /api/chat/supervision
```

ç¤ºä¾‹è¯·æ±‚ï¼š

```json
{
  "email": "parent@example.com",
  "password": "securepassword",
  "name": "å¼ çˆ¸çˆ¸"
}
```

## 5. æ•°æ®æ¨¡å‹

### 5.1 æ•°æ®æ¨¡å‹å®šä¹‰

```mermaid
erDiagram
    USERS ||--o{ FAMILY_MEMBERS : belongs_to
    FAMILIES ||--o{ FAMILY_MEMBERS : contains
    FAMILIES ||--o{ CHILDREN : contains
    FAMILIES ||--o{ RULES : has
    CHILDREN ||--o{ BEHAVIORS : performs
    CHILDREN ||--o{ FRIENDSHIPS : has
    CHILDREN ||--o{ CHALLENGE_PARTICIPANTS : joins
    RULES ||--o{ BEHAVIORS : applies_to
    CHILDREN ||--o{ REWARDS : earns
    CHILDREN ||--o{ CHAT_MESSAGES : sends
    CHALLENGES ||--o{ CHALLENGE_PARTICIPANTS : includes

    USERS {
        uuid id PK
        string email
        string name
        string role
        string avatar_url
        timestamp created_at
    }
    
    FAMILIES {
        uuid id PK
        uuid creator_id FK
        string name
        string description
        string invite_code
        timestamp created_at
    }
    
    FAMILY_MEMBERS {
        uuid id PK
        uuid family_id FK
        uuid user_id FK
        string role
        string permissions
        timestamp joined_at
    }
    
    CHILDREN {
        uuid id PK
        uuid family_id FK
        string name
        date birth_date
        int total_points
        string avatar_url
        string child_invite_code
        timestamp created_at
    }
    
    FRIENDSHIPS {
        uuid id PK
        uuid child_id FK
        uuid friend_id FK
        string status
        timestamp created_at
    }
    
    CHALLENGES {
        uuid id PK
        uuid creator_id FK
        string title
        string description
        string type
        int duration_days
        int points_reward
        timestamp start_date
        timestamp end_date
    }
    
    CHALLENGE_PARTICIPANTS {
        uuid id PK
        uuid challenge_id FK
        uuid child_id FK
        string status
        int progress
        timestamp joined_at
    }
    
    CHAT_MESSAGES {
        uuid id PK
        uuid sender_id FK
        uuid receiver_id FK
        string message_type
        string content
        boolean is_approved
        timestamp created_at
    }
    
    RULES {
        uuid id PK
        uuid family_id FK
        string type
        string category
        string name
        int points
        string icon
        string description
        boolean is_active
        uuid created_by FK
    }
    
    BEHAVIORS {
        uuid id PK
        uuid child_id FK
        uuid rule_id FK
        int points_change
        string note
        uuid recorded_by FK
        timestamp created_at
    }
    
    REWARDS {
        uuid id PK
        uuid child_id FK
        string name
        int points_cost
        string status
        uuid approved_by FK
        timestamp created_at
    }
```

### 5.2 æ•°æ®å®šä¹‰è¯­è¨€

**ç”¨æˆ·è¡¨ (users)**

```sql
-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) DEFAULT 'parent' CHECK (role IN ('parent', 'child')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå®¶åº­è¡¨
CREATE TABLE families (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    invite_code VARCHAR(10) UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå®¶åº­æˆå‘˜è¡¨
CREATE TABLE family_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    family_id UUID REFERENCES families(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(20) DEFAULT 'member' CHECK (role IN ('admin', 'member', 'observer')),
    permissions TEXT[], -- æƒé™æ•°ç»„
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå„¿ç«¥è¡¨
CREATE TABLE children (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    family_id UUID REFERENCES families(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    birth_date DATE,
    total_points INTEGER DEFAULT 0,
    avatar_url VARCHAR(255),
    child_invite_code VARCHAR(8) UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå¥½å‹å…³ç³»è¡¨
CREATE TABLE friendships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id) ON DELETE CASCADE,
    friend_id UUID REFERENCES children(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'blocked')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(child_id, friend_id)
);

-- åˆ›å»ºæŒ‘æˆ˜è¡¨
CREATE TABLE challenges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID REFERENCES children(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    type VARCHAR(20) CHECK (type IN ('habit', 'task', 'competition')),
    duration_days INTEGER DEFAULT 7,
    points_reward INTEGER DEFAULT 0,
    start_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    end_date TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºæŒ‘æˆ˜å‚ä¸è€…è¡¨
CREATE TABLE challenge_participants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    challenge_id UUID REFERENCES challenges(id) ON DELETE CASCADE,
    child_id UUID REFERENCES children(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'completed', 'failed', 'quit')),
    progress INTEGER DEFAULT 0,
    joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(challenge_id, child_id)
);

-- åˆ›å»ºèŠå¤©æ¶ˆæ¯è¡¨
CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    sender_id UUID REFERENCES children(id) ON DELETE CASCADE,
    receiver_id UUID REFERENCES children(id) ON DELETE CASCADE,
    message_type VARCHAR(20) DEFAULT 'text' CHECK (message_type IN ('text', 'emoji', 'preset')),
    content TEXT NOT NULL,
    is_approved BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºè§„åˆ™è¡¨
CREATE TABLE rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    family_id UUID REFERENCES families(id) ON DELETE CASCADE,
    type VARCHAR(20) NOT NULL CHECK (type IN ('reward', 'punishment')),
    category VARCHAR(20) NOT NULL,
    name VARCHAR(200) NOT NULL,
    points INTEGER NOT NULL,
    icon VARCHAR(50),
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_by UUID REFERENCES users(id),
    requires_approval BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºè¡Œä¸ºè®°å½•è¡¨
CREATE TABLE behaviors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id) ON DELETE CASCADE,
    rule_id UUID REFERENCES rules(id) ON DELETE CASCADE,
    points_change INTEGER NOT NULL,
    note TEXT,
    recorded_by UUID REFERENCES users(id),
    is_verified BOOLEAN DEFAULT false,
    verified_by UUID REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå¥–åŠ±å…‘æ¢è¡¨
CREATE TABLE rewards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id) ON DELETE CASCADE,
    name VARCHAR(200) NOT NULL,
    points_cost INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'completed', 'rejected')),
    approved_by UUID REFERENCES users(id),
    approval_note TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_behaviors_child_id ON behaviors(child_id);
CREATE INDEX idx_behaviors_created_at ON behaviors(created_at DESC);
CREATE INDEX idx_rules_family_id ON rules(family_id);
CREATE INDEX idx_children_family_id ON children(family_id);
CREATE INDEX idx_family_members_family_id ON family_members(family_id);
CREATE INDEX idx_family_members_user_id ON family_members(user_id);
CREATE INDEX idx_friendships_child_id ON friendships(child_id);
CREATE INDEX idx_friendships_friend_id ON friendships(friend_id);
CREATE INDEX idx_challenges_creator_id ON challenges(creator_id);
CREATE INDEX idx_challenge_participants_challenge_id ON challenge_participants(challenge_id);
CREATE INDEX idx_challenge_participants_child_id ON challenge_participants(child_id);
CREATE INDEX idx_chat_messages_sender_id ON chat_messages(sender_id);
CREATE INDEX idx_chat_messages_receiver_id ON chat_messages(receiver_id);
CREATE INDEX idx_chat_messages_created_at ON chat_messages(created_at DESC);

-- è®¾ç½®RLSç­–ç•¥
ALTER TABLE families ENABLE ROW LEVEL SECURITY;
ALTER TABLE family_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE children ENABLE ROW LEVEL SECURITY;
ALTER TABLE rules ENABLE ROW LEVEL SECURITY;
ALTER TABLE behaviors ENABLE ROW LEVEL SECURITY;
ALTER TABLE rewards ENABLE ROW LEVEL SECURITY;
ALTER TABLE friendships ENABLE ROW LEVEL SECURITY;
ALTER TABLE challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE challenge_participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;

-- åŸºç¡€æƒé™è®¾ç½®
GRANT SELECT ON families TO anon;
GRANT ALL PRIVILEGES ON families TO authenticated;
GRANT SELECT ON family_members TO anon;
GRANT ALL PRIVILEGES ON family_members TO authenticated;
GRANT SELECT ON children TO anon;
GRANT ALL PRIVILEGES ON children TO authenticated;
GRANT SELECT ON rules TO anon;
GRANT ALL PRIVILEGES ON rules TO authenticated;
GRANT SELECT ON behaviors TO anon;
GRANT ALL PRIVILEGES ON behaviors TO authenticated;
GRANT SELECT ON rewards TO anon;
GRANT ALL PRIVILEGES ON rewards TO authenticated;
GRANT SELECT ON friendships TO anon;
GRANT ALL PRIVILEGES ON friendships TO authenticated;
GRANT SELECT ON challenges TO anon;
GRANT ALL PRIVILEGES ON challenges TO authenticated;
GRANT SELECT ON challenge_participants TO anon;
GRANT ALL PRIVILEGES ON challenge_participants TO authenticated;
GRANT SELECT ON chat_messages TO anon;
GRANT ALL PRIVILEGES ON chat_messages TO authenticated;

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO rules (family_id, type, category, name, points, icon, description, requires_approval) VALUES
('00000000-0000-0000-0000-000000000000', 'reward', 'daily', 'è‡ªå·±åƒé¥­', 2, 'ğŸ‘¶ğŸ¥„', 'ä¸æŒ‘é£Ÿã€ä¸æµªè´¹', false),
('00000000-0000-0000-0000-000000000000', 'reward', 'daily', 'è‡ªå·±åˆ·ç‰™', 1, 'ğŸ§¸ğŸª¥', 'æ—©æ™šå„ä¸€æ¬¡ã€ä¸»åŠ¨å®Œæˆ', false),
('00000000-0000-0000-0000-000000000000', 'punishment', 'minor', 'ä¸å¬è¯å“­é—¹', -1, 'ğŸ‘¶ğŸ™…â€â™‚ï¸âŒ', 'ä»»æ€§ã€å“­é—¹è¡Œä¸º', true),
('00000000-0000-0000-0000-000000000000', 'punishment', 'serious', 'å±é™©è¡Œä¸º', -10, 'ğŸ‘¶âš ï¸âŒ', 'å¦‚çˆ¬é«˜ã€ç©ç«ç­‰', true),
(NULL, 'reward', 'study', 'å®Œæˆä½œä¸š', 10, 'ğŸ“š', 'æŒ‰æ—¶å®Œæˆå½“å¤©çš„ä½œä¸š', false),
(NULL, 'reward', 'chores', 'æ•´ç†æˆ¿é—´', 15, 'ğŸ§¹', 'ä¸»åŠ¨æ•´ç†è‡ªå·±çš„æˆ¿é—´', false),
(NULL, 'reward', 'behavior', 'å¸®åŠ©ä»–äºº', 20, 'ğŸ¤', 'ä¸»åŠ¨å¸®åŠ©å®¶äººæˆ–æœ‹å‹', false),
(NULL, 'punishment', 'behavior', 'è¯´è°', -20, 'ğŸ¤¥', 'å¯¹å®¶äººè¯´è°æˆ–éšç’äº‹å®', true),
(NULL, 'punishment', 'behavior', 'ä¸å¬è¯', -10, 'ğŸ˜¤', 'ä¸å¬ä»å®¶é•¿çš„åˆç†è¦æ±‚', true);

-- åˆå§‹åŒ–æŒ‘æˆ˜æ¨¡æ¿
INSERT INTO challenges (creator_id, title, description, type, duration_days, points_reward) VALUES
(NULL, 'æ—©èµ·æŒ‘æˆ˜', 'è¿ç»­7å¤©æ—©ä¸Š7ç‚¹å‰èµ·åºŠ', 'habit', 7, 50),
(NULL, 'é˜…è¯»é©¬æ‹‰æ¾', 'æ¯å¤©é˜…è¯»30åˆ†é’Ÿï¼ŒåšæŒä¸€å‘¨', 'habit', 7, 70),
(NULL, 'å®¶åŠ¡å°èƒ½æ‰‹', 'æ¯å¤©å®Œæˆä¸€é¡¹å®¶åŠ¡ï¼ŒæŒç»­ä¸€å‘¨', 'task', 7, 60),
(NULL, 'è¿åŠ¨è¾¾äºº', 'æ¯å¤©è¿åŠ¨30åˆ†é’Ÿï¼ŒåšæŒä¸€å‘¨', 'habit', 7, 80);

-- é¢„è®¾å®‰å…¨èŠå¤©æ¶ˆæ¯
CREATE TABLE preset_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    emoji VARCHAR(10)
);

INSERT INTO preset_messages (category, content, emoji) VALUES
('encouragement', 'ä½ çœŸæ£’ï¼', 'ğŸ‘'),
('encouragement', 'åŠ æ²¹ï¼', 'ğŸ’ª'),
('encouragement', 'ç»§ç»­åŠªåŠ›ï¼', 'ğŸŒŸ'),
('greeting', 'ä½ å¥½ï¼', 'ğŸ‘‹'),
('greeting', 'æ—©ä¸Šå¥½ï¼', 'ğŸŒ…'),
('greeting', 'æ™šå®‰ï¼', 'ğŸŒ™'),
('celebration', 'æ­å–œä½ ï¼', 'ğŸ‰'),
('celebration', 'å¤ªå‰å®³äº†ï¼', 'ğŸ†'),
('support', 'æˆ‘æ”¯æŒä½ ï¼', 'ğŸ¤—'),
('support', 'æˆ‘ä»¬ä¸€èµ·åŠ æ²¹ï¼', 'ğŸ‘«');
```

