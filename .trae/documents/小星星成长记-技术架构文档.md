# å°æ˜Ÿæ˜Ÿæˆé•¿è®° - æŠ€æœ¯æ¶æ„æ–‡æ¡£

## 1. æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[ç”¨æˆ·æµè§ˆå™¨] --> B[Reactå‰ç«¯åº”ç”¨]
    B --> C[Supabase SDK]
    C --> D[SupabaseæœåŠ¡]
    
    subgraph "å‰ç«¯å±‚"
        B
    end
    
    subgraph "æœåŠ¡å±‚ (Supabaseæä¾›)"
        D --> D1[PostgreSQLæ•°æ®åº“]
        D --> D2[å®æ—¶è®¢é˜…]
        D --> D3[ç”¨æˆ·è®¤è¯]
        D --> D4[æ–‡ä»¶å­˜å‚¨]
    end
```

## 2. æŠ€æœ¯æè¿°

* å‰ç«¯ï¼šReact\@18 + TypeScript + TailwindCSS + Vite

* åç«¯ï¼šSupabase (PostgreSQL + å®æ—¶API + è®¤è¯)

* çŠ¶æ€ç®¡ç†ï¼šZustand

* UIç»„ä»¶ï¼šHeadless UI + è‡ªå®šä¹‰ç»„ä»¶

* å›¾è¡¨åº“ï¼šChart.js

* éƒ¨ç½²ï¼šVercel

## 3. è·¯ç”±å®šä¹‰

| è·¯ç”±         | ç”¨é€”               |
| ---------- | ---------------- |
| /          | é¦–é¡µï¼Œæ˜¾ç¤ºç§¯åˆ†æ¦‚è§ˆå’Œå¿«é€Ÿå¯¼èˆª   |
| /login     | ç™»å½•é¡µé¢ï¼Œæ”¯æŒæ‰‹æœºå·å’Œé‚®ç®±ç™»å½•  |
| /register  | æ³¨å†Œé¡µé¢ï¼Œåˆ›å»ºå®¶é•¿è´¦æˆ·      |
| /dashboard | ä»ªè¡¨æ¿ï¼Œå®¶åº­æ¦‚è§ˆå’Œæ•°æ®ç»Ÿè®¡    |
| /rules     | è§„åˆ™ç®¡ç†é¡µé¢ï¼Œç®¡ç†å¥–æƒ©è§„åˆ™    |
| /records   | è¡Œä¸ºè®°å½•é¡µé¢ï¼Œè®°å½•å’ŒæŸ¥çœ‹è¡Œä¸ºå†å² |
| /rewards   | ç§¯åˆ†å…‘æ¢é¡µé¢ï¼ŒæŸ¥çœ‹å’Œå…‘æ¢å¥–åŠ±   |
| /reports   | ç»Ÿè®¡æŠ¥å‘Šé¡µé¢ï¼ŒæŸ¥çœ‹æˆé•¿åˆ†æ    |
| /settings  | è®¾ç½®é¡µé¢ï¼Œç”¨æˆ·å’Œç³»ç»Ÿè®¾ç½®     |
| /family    | å®¶åº­ç®¡ç†é¡µé¢ï¼Œç®¡ç†å®¶åº­æˆå‘˜    |

## 4. APIå®šä¹‰

### 4.1 æ ¸å¿ƒAPI

**ç”¨æˆ·è®¤è¯ç›¸å…³**

```
POST /auth/signup
```

è¯·æ±‚å‚æ•°ï¼š

| å‚æ•°å      | å‚æ•°ç±»å‹   | æ˜¯å¦å¿…éœ€ | æè¿°   |
| -------- | ------ | ---- | ---- |
| email    | string | true | ç”¨æˆ·é‚®ç®± |
| password | string | true | ç”¨æˆ·å¯†ç  |
| name     | string | true | ç”¨æˆ·å§“å |

å“åº”å‚æ•°ï¼š

| å‚æ•°å     | å‚æ•°ç±»å‹   | æè¿°     |
| ------- | ------ | ------ |
| user    | object | ç”¨æˆ·ä¿¡æ¯å¯¹è±¡ |
| session | object | ä¼šè¯ä¿¡æ¯   |

**è§„åˆ™ç®¡ç†ç›¸å…³**

```
POST /api/rules
GET /api/rules
PUT /api/rules/:id
DELETE /api/rules/:id
```

**è¡Œä¸ºè®°å½•ç›¸å…³**

```
POST /api/behaviors
GET /api/behaviors
GET /api/behaviors/stats
```

ç¤ºä¾‹è¯·æ±‚ï¼š

```json
{
  "email": "parent@example.com",
  "password": "securepassword",
  "name": "å¼ çˆ¸çˆ¸"
}
```

## 5. æ•°æ®æ¨¡å‹

### 5.1 æ•°æ®æ¨¡å‹å®šä¹‰

```mermaid
erDiagram
    USERS ||--o{ FAMILIES : creates
    FAMILIES ||--o{ CHILDREN : contains
    FAMILIES ||--o{ RULES : has
    CHILDREN ||--o{ BEHAVIORS : performs
    RULES ||--o{ BEHAVIORS : applies_to
    CHILDREN ||--o{ REWARDS : earns

    USERS {
        uuid id PK
        string email
        string name
        string role
        timestamp created_at
    }
    
    FAMILIES {
        uuid id PK
        uuid creator_id FK
        string name
        string invite_code
        timestamp created_at
    }
    
    CHILDREN {
        uuid id PK
        uuid family_id FK
        string name
        date birth_date
        int total_points
        timestamp created_at
    }
    
    RULES {
        uuid id PK
        uuid family_id FK
        string type
        string category
        string name
        int points
        string icon
        string description
        boolean is_active
    }
    
    BEHAVIORS {
        uuid id PK
        uuid child_id FK
        uuid rule_id FK
        int points_change
        string note
        timestamp created_at
    }
    
    REWARDS {
        uuid id PK
        uuid child_id FK
        string name
        int points_cost
        string status
        timestamp created_at
    }
```

### 5.2 æ•°æ®å®šä¹‰è¯­è¨€

**ç”¨æˆ·è¡¨ (users)**

```sql
-- åˆ›å»ºç”¨æˆ·è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) DEFAULT 'parent' CHECK (role IN ('parent', 'child')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå®¶åº­è¡¨
CREATE TABLE families (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    invite_code VARCHAR(10) UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå„¿ç«¥è¡¨
CREATE TABLE children (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    family_id UUID REFERENCES families(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    birth_date DATE,
    total_points INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºè§„åˆ™è¡¨
CREATE TABLE rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    family_id UUID REFERENCES families(id) ON DELETE CASCADE,
    type VARCHAR(20) NOT NULL CHECK (type IN ('reward', 'punishment')),
    category VARCHAR(20) NOT NULL,
    name VARCHAR(200) NOT NULL,
    points INTEGER NOT NULL,
    icon VARCHAR(50),
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºè¡Œä¸ºè®°å½•è¡¨
CREATE TABLE behaviors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id) ON DELETE CASCADE,
    rule_id UUID REFERENCES rules(id) ON DELETE CASCADE,
    points_change INTEGER NOT NULL,
    note TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºå¥–åŠ±å…‘æ¢è¡¨
CREATE TABLE rewards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    child_id UUID REFERENCES children(id) ON DELETE CASCADE,
    name VARCHAR(200) NOT NULL,
    points_cost INTEGER NOT NULL,
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'completed')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_behaviors_child_id ON behaviors(child_id);
CREATE INDEX idx_behaviors_created_at ON behaviors(created_at DESC);
CREATE INDEX idx_rules_family_id ON rules(family_id);
CREATE INDEX idx_children_family_id ON children(family_id);

-- è®¾ç½®RLSç­–ç•¥
ALTER TABLE families ENABLE ROW LEVEL SECURITY;
ALTER TABLE children ENABLE ROW LEVEL SECURITY;
ALTER TABLE rules ENABLE ROW LEVEL SECURITY;
ALTER TABLE behaviors ENABLE ROW LEVEL SECURITY;
ALTER TABLE rewards ENABLE ROW LEVEL SECURITY;

-- åŸºç¡€æƒé™è®¾ç½®
GRANT SELECT ON families TO anon;
GRANT ALL PRIVILEGES ON families TO authenticated;
GRANT ALL PRIVILEGES ON children TO authenticated;
GRANT ALL PRIVILEGES ON rules TO authenticated;
GRANT ALL PRIVILEGES ON behaviors TO authenticated;
GRANT ALL PRIVILEGES ON rewards TO authenticated;

-- åˆå§‹åŒ–æ•°æ®
INSERT INTO rules (family_id, type, category, name, points, icon, description) VALUES
('00000000-0000-0000-0000-000000000000', 'reward', 'daily', 'è‡ªå·±åƒé¥­', 2, 'ğŸ‘¶ğŸ¥„', 'ä¸æŒ‘é£Ÿã€ä¸æµªè´¹'),
('00000000-0000-0000-0000-000000000000', 'reward', 'daily', 'è‡ªå·±åˆ·ç‰™', 1, 'ğŸ§¸ğŸª¥', 'æ—©æ™šå„ä¸€æ¬¡ã€ä¸»åŠ¨å®Œæˆ'),
('00000000-0000-0000-0000-000000000000', 'punishment', 'minor', 'ä¸å¬è¯å“­é—¹', -1, 'ğŸ‘¶ğŸ™…â€â™‚ï¸âŒ', 'ä»»æ€§ã€å“­é—¹è¡Œä¸º'),
('00000000-0000-0000-0000-000000000000', 'punishment', 'serious', 'å±é™©è¡Œä¸º', -10, 'ğŸ‘¶âš ï¸âŒ', 'å¦‚çˆ¬é«˜ã€ç©ç«ç­‰');
```

